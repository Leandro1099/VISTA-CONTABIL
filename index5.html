<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISTA CONTABIL | Enterprise Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vista Contábil">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2641/2641040.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --bg-deep: #0a0f1d; --bg-surface: #161e31; --accent: #6366f1; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-deep); color: #f1f5f9; overflow-x: hidden; }
        .card-premium { background: var(--bg-surface); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .sidebar-active { background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent); color: white !important; }
        .input-standard { background: rgba(10, 15, 29, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
        .input-standard:focus { border-color: var(--accent); outline: none; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .password-hide { -webkit-text-security: disc; }
        
        /* Estilo do Contrato */
        .folha-contrato { background: white; color: #1a1a1a; padding: 50px; font-family: 'Times New Roman', serif; line-height: 1.6; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .texto-contrato { text-align: justify; text-indent: 2em; margin-bottom: 1em; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-[#070b14] border-r border-white/5 flex flex-col fixed h-full z-50">
        <div class="p-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-eye text-lg"></i></div>
                <h1 class="text-lg font-extrabold tracking-tighter text-white uppercase">Vista <span class="text-indigo-500 font-light">Contábil</span></h1>
            </div>
        </div>
        <nav class="flex-1 px-3 space-y-1 mt-4">
            <button onclick="router('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-chart-line w-5"></i> Dashboard</button>
            <button onclick="router('clientes')" id="nav-clientes" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-building w-5"></i> Clientes</button>
            <button onclick="router('contratos')" id="nav-contratos" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-file-contract w-5"></i> Gerador de Contratos</button>
            <button onclick="router('busca')" id="nav-busca" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-search w-5"></i> Busca Global</button>
        </nav>
        
        <div class="p-4 border-t border-white/5 space-y-2">
            <button onclick="abrirConfigContratante()" class="w-full text-[10px] text-indigo-400 hover:text-white uppercase font-bold tracking-widest py-2">
                <i class="fas fa-cog mr-2"></i> Dados da Contabilidade
            </button>
            <button onclick="exportarBackup()" class="w-full text-[10px] text-slate-500 hover:text-white uppercase font-bold tracking-widest py-2">
                <i class="fas fa-download mr-2"></i> Download Backup
            </button>
        </div>
    </aside>

    <main class="ml-64 flex-1 p-10 bg-[#0a0f1d]">
        <section id="view-dashboard" class="content-view">
            <h2 class="text-2xl font-bold text-white mb-8">Panorama Geral</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card-premium p-8 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total de Clientes</p>
                    <h3 id="dash-clientes" class="text-5xl font-extrabold text-white">0</h3>
                </div>
                <div class="card-premium p-8 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase mb-2">Arquivos Salvos</p>
                    <h3 id="dash-arquivos" class="text-5xl font-extrabold text-white">0</h3>
                </div>
            </div>
        </section>

        <section id="view-clientes" class="content-view hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white">Gestão de Clientes</h2>
                <div class="flex gap-2">
                    <button onclick="gerarRelatorioClientes()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition-all"><i class="fas fa-file-pdf mr-2"></i> Relatório</button>
                    <button onclick="abrirModalCadastro()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition-all shadow-lg">+ Novo Cliente</button>
                </div>
            </div>
            <div class="input-standard p-1 rounded-xl mb-6 flex items-center gap-3 px-4">
                <i class="fas fa-search text-slate-500 text-sm"></i>
                <input type="text" id="input-busca" onkeyup="renderizarTabela()" placeholder="Filtrar por nome ou CNPJ..." class="w-full py-2 bg-transparent outline-none text-sm">
            </div>
            <div class="card-premium rounded-xl overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white/5 border-b border-white/10">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Razão Social</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">CNPJ</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lista-clientes" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </section>

        <section id="view-contratos" class="content-view hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white">Gerador de Contrato de Prestação de Serviços</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="card-premium p-6 rounded-2xl">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">1. Selecione o Cliente</label>
                        <select id="select-cliente-contrato" onchange="previewContrato()" class="w-full input-standard rounded-lg px-4 py-3 text-sm">
                            <option value="">Selecione um cliente...</option>
                        </select>
                    </div>
                    
                    <div class="card-premium p-6 rounded-2xl">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">2. Valor dos Honorários</label>
                        <input type="text" id="contrato-valor" oninput="previewContrato()" placeholder="Ex: R$ 1.200,00" class="w-full input-standard rounded-lg px-4 py-3 text-sm">
                        
                        <label class="text-[10px] font-bold text-slate-400 uppercase mt-4 mb-2 block">3. Data de Vencimento</label>
                        <input type="number" id="contrato-venc" oninput="previewContrato()" placeholder="Dia (Ex: 10)" class="w-full input-standard rounded-lg px-4 py-3 text-sm">
                    </div>

                    <button onclick="gerarPDFContrato()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold shadow-xl transition-all">
                        <i class="fas fa-file-pdf mr-2"></i> GERAR CONTRATO PDF
                    </button>
                </div>

                <div class="lg:col-span-2">
                    <div id="preview-contrato-container" class="folha-contrato rounded-sm overflow-y-auto max-h-[800px]">
                        </div>
                </div>
            </div>
        </section>

        <section id="view-busca" class="content-view hidden">
            <h2 class="text-2xl font-bold text-white mb-8">Busca Inteligente</h2>
            <div class="input-standard p-1 rounded-xl mb-8 flex items-center gap-3 px-4 border-2 border-indigo-500/20">
                <i class="fas fa-search text-indigo-500"></i>
                <input type="text" id="input-busca-global" onkeyup="executarBuscaGlobal()" placeholder="Digite o nome de um arquivo para localizar..." class="w-full py-3 bg-transparent outline-none text-sm">
            </div>
            <div id="resultados-busca" class="grid grid-cols-1 gap-4"></div>
        </section>

        <section id="view-detalhes" class="content-view hidden">
            <button onclick="router('clientes')" class="mb-6 text-sm text-indigo-400 hover:underline font-bold"><i class="fas fa-arrow-left mr-2"></i> Lista de Clientes</button>
            <div id="painel-info-cliente" class="card-premium rounded-2xl p-8 mb-8 relative"></div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Diretórios</h3>
                <button onclick="promptNovaPasta()" class="text-sm bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg border border-white/10 font-bold transition-all">Nova Pasta</button>
            </div>
            <div id="grid-pastas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>

        <section id="view-arquivos" class="content-view hidden">
            <button onclick="router('detalhes')" class="mb-6 text-sm text-indigo-400 hover:underline font-bold"><i class="fas fa-arrow-left mr-2"></i> Pastas</button>
            <div class="bg-indigo-600/20 border border-indigo-500/30 p-8 rounded-2xl flex justify-between items-center mb-4">
                <h3 id="titulo-pasta-atual" class="text-2xl font-bold text-white"></h3>
                <label class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold text-sm cursor-pointer hover:bg-indigo-500">Subir PDF<input type="file" class="hidden" onchange="fazerUpload(this)"></label>
            </div>
            <div id="grid-arquivos" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>
    </main>

    <div id="modal-config" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-6">
        <div class="bg-[#161e31] rounded-2xl w-full max-w-md border border-white/10 shadow-2xl p-8">
            <h3 class="text-lg font-bold text-white mb-6">Dados Fixos do Contratante</h3>
            <div class="space-y-4">
                <input type="text" id="cfg-nome" placeholder="Nome da Sua Contabilidade" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm">
                <input type="text" id="cfg-cnpj" placeholder="Seu CNPJ" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm">
                <input type="text" id="cfg-endereco" placeholder="Seu Endereço Completo" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm">
                <input type="text" id="cfg-representante" placeholder="Nome do Responsável / CPF" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm">
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="salvarConfigContratante()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold">Salvar Dados</button>
                <button onclick="toggleModal('modal-config', false)" class="px-4 text-slate-400">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-cliente" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-6">
        <div class="bg-[#161e31] rounded-2xl w-full max-w-xl border border-white/10 shadow-2xl flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Cadastro de Empresa</h3>
                <button onclick="toggleModal('modal-cliente', false)" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-cliente" class="p-8 space-y-4">
                <input type="hidden" id="field-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">CNPJ</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="f-cnpj" maxlength="18" oninput="mascaraCNPJ(this)" placeholder="00.000.000/0000-00" class="flex-1 input-standard rounded-lg px-4 py-2.5 text-sm" required>
                            <button type="button" onclick="consultarCNPJ()" id="btn-consulta" class="bg-slate-700 hover:bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">CEP</label>
                        <input type="text" id="f-cep" maxlength="9" oninput="mascaraCEP(this)" onblur="buscarCEP(this.value)" placeholder="00000-000" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Razão Social</label>
                    <input type="text" id="f-nome" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1" required>
                </div>
                <div class="grid grid-cols-4 gap-3">
                    <div class="col-span-3">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Logradouro</label>
                        <input type="text" id="f-rua" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1 bg-white/5" readonly>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Nº</label>
                        <input type="text" id="f-num" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Bairro / Cidade</label>
                    <input type="text" id="f-bairro-cid" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1 bg-white/5" readonly>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="f-s-pref" placeholder="Senha Pref." class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-s-simp" placeholder="Senha Simples" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-s-seg" placeholder="Senha Seguro" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-a1" placeholder="Certificado A1" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold text-sm">Salvar Registro</button>
                    <button type="button" id="btn-deletar-c" class="hidden px-5 bg-red-600/10 text-red-500 rounded-lg font-bold text-sm hover:bg-red-600 hover:text-white">Excluir</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let db;
        let segurancaAtiva = true;
        const req = indexedDB.open("VistaEnterpriseDB", 1);
        
        req.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("clientes", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("pastas", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("arquivos", { keyPath: "id", autoIncrement: true });
        };
        req.onsuccess = (e) => { db = e.target.result; router('dashboard'); };

        function router(view) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-active'));
            document.getElementById('view-' + view).classList.remove('hidden');
            const btn = document.getElementById('nav-' + view);
            if(btn) btn.classList.add('sidebar-active');
            
            if(view === 'clientes') carregarClientes();
            if(view === 'dashboard') atualizarDash();
            if(view === 'contratos') prepararGerador();
        }

        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

        // --- LÓGICA DO GERADOR DE CONTRATOS ---
        function abrirConfigContratante() {
            const cfg = JSON.parse(localStorage.getItem('vista_contratante') || '{}');
            document.getElementById('cfg-nome').value = cfg.nome || '';
            document.getElementById('cfg-cnpj').value = cfg.cnpj || '';
            document.getElementById('cfg-endereco').value = cfg.endereco || '';
            document.getElementById('cfg-representante').value = cfg.representante || '';
            toggleModal('modal-config', true);
        }

        function salvarConfigContratante() {
            const cfg = {
                nome: document.getElementById('cfg-nome').value,
                cnpj: document.getElementById('cfg-cnpj').value,
                endereco: document.getElementById('cfg-endereco').value,
                representante: document.getElementById('cfg-representante').value
            };
            localStorage.setItem('vista_contratante', JSON.stringify(cfg));
            toggleModal('modal-config', false);
            if(clienteAtivo) previewContrato();
        }

        function prepararGerador() {
            db.transaction("clientes").objectStore("clientes").getAll().onsuccess = (e) => {
                const select = document.getElementById('select-cliente-contrato');
                const clientes = e.target.result;
                select.innerHTML = '<option value="">Selecione um cliente...</option>' + 
                    clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                previewContrato();
            };
        }

        function previewContrato() {
            const clienteId = document.getElementById('select-cliente-contrato').value;
            const valor = document.getElementById('contrato-valor').value || '__________';
            const venc = document.getElementById('contrato-venc').value || '__';
            const cfg = JSON.parse(localStorage.getItem('vista_contratante') || '{"nome":"[CONFIGURAR CONTRATANTE]"}');
            
            if(!clienteId) {
                document.getElementById('preview-contrato-container').innerHTML = "<p class='text-slate-400 italic'>Selecione um cliente para visualizar o contrato...</p>";
                return;
            }

            db.transaction("clientes").objectStore("clientes").get(Number(clienteId)).onsuccess = (e) => {
                const cli = e.target.result;
                const dataAtual = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                document.getElementById('preview-contrato-container').innerHTML = `
                    <div style="text-align: center; font-weight: bold; font-size: 1.2rem; margin-bottom: 2rem; text-decoration: underline;">
                        CONTRATO DE PRESTAÇÃO DE SERVIÇOS CONTÁBEIS
                    </div>
                    
                    <div class="texto-contrato">
                        <strong>CONTRATANTE:</strong> ${cfg.nome}, inscrito no CNPJ sob o nº ${cfg.cnpj}, com sede em ${cfg.endereco}, neste ato representado por ${cfg.representante}.
                    </div>
                    
                    <div class="texto-contrato">
                        <strong>CONTRATADO:</strong> ${cli.nome}, inscrito no CNPJ sob o nº ${cli.cnpj}, com sede em ${cli.rua}, nº ${cli.num}, ${cli.bairro_cid}.
                    </div>

                    <div class="texto-contrato">
                        <strong>CLÁUSULA PRIMEIRA - DO OBJETO:</strong> O presente contrato tem por objeto a prestação de serviços de assessoria contábil, fiscal e trabalhista, conforme as normas vigentes do Conselho Federal de Contabilidade.
                    </div>

                    <div class="texto-contrato">
                        <strong>CLÁUSULA SEGUNDA - DOS HONORÁRIOS:</strong> Pelos serviços prestados, a CONTRATADA pagará à CONTRATANTE o valor mensal de <strong>${valor}</strong>, com vencimento todo dia <strong>${venc}</strong> de cada mês.
                    </div>

                    <div class="texto-contrato">
                        <strong>CLÁUSULA TERCEIRA - DA VIGÊNCIA:</strong> O presente instrumento terá vigência por prazo indeterminado, podendo ser rescindido por qualquer das partes mediante aviso prévio de 30 (trinta) dias por escrito.
                    </div>

                    <div class="texto-contrato">
                        <strong>CLÁUSULA QUARTA - DO FORO:</strong> Fica eleito o foro da comarca de localidade da CONTRATANTE para dirimir quaisquer dúvidas oriundas deste contrato.
                    </div>

                    <div style="margin-top: 3rem; text-align: right;">
                        Localidade, ${dataAtual}.
                    </div>

                    <div style="margin-top: 5rem; display: flex; justify-content: space-around;">
                        <div style="border-top: 1px solid black; width: 200px; text-align: center; font-size: 0.8rem;">CONTRATANTE</div>
                        <div style="border-top: 1px solid black; width: 200px; text-align: center; font-size: 0.8rem;">CONTRATADO</div>
                    </div>
                `;
            };
        }

        async function gerarPDFContrato() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const element = document.getElementById('preview-contrato-container');
            
            // Usamos uma abordagem de texto puro para garantir a qualidade jurídica e justificação
            const cfg = JSON.parse(localStorage.getItem('vista_contratante') || '{}');
            const clienteId = document.getElementById('select-cliente-contrato').value;
            const valor = document.getElementById('contrato-valor').value || '__________';
            const venc = document.getElementById('contrato-venc').value || '__';
            
            if(!clienteId || !cfg.nome) return alert("Configure os dados da contabilidade e selecione um cliente.");

            db.transaction("clientes").objectStore("clientes").get(Number(clienteId)).onsuccess = (e) => {
                const cli = e.target.result;
                const dataAtual = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });

                doc.setFont("times", "bold");
                doc.setFontSize(14);
                doc.text("CONTRATO DE PRESTAÇÃO DE SERVIÇOS CONTÁBEIS", 105, 25, { align: 'center' });
                
                doc.setFont("times", "normal");
                doc.setFontSize(11);
                
                let y = 45;
                const margem = 20;
                const larguraUtil = 170;

                const s1 = `CONTRATANTE: ${cfg.nome}, inscrito no CNPJ sob o nº ${cfg.cnpj}, com sede em ${cfg.endereco}, neste ato representado por ${cfg.representante}.`;
                const s2 = `CONTRATADO: ${cli.nome}, inscrito no CNPJ sob o nº ${cli.cnpj}, com sede em ${cli.rua}, nº ${cli.num}, ${cli.bairro_cid}.`;
                const c1 = `CLÁUSULA PRIMEIRA - DO OBJETO: O presente contrato tem por objeto a prestação de serviços de assessoria contábil, fiscal e trabalhista, conforme as normas vigentes do Conselho Federal de Contabilidade.`;
                const c2 = `CLÁUSULA SEGUNDA - DOS HONORÁRIOS: Pelos serviços prestados, a CONTRATADA pagará à CONTRATANTE o valor mensal de ${valor}, com vencimento todo dia ${venc} de cada mês.`;
                const c3 = `CLÁUSULA TERCEIRA - DA VIGÊNCIA: O presente instrumento terá vigência por prazo indeterminado, podendo ser rescindido por qualquer das partes mediante aviso prévio de 30 (trinta) dias por escrito.`;

                [s1, s2, c1, c2, c3].forEach(txt => {
                    const lines = doc.splitTextToSize(txt, larguraUtil);
                    doc.text(lines, margem, y, { align: 'justify', maxWidth: larguraUtil });
                    y += (lines.length * 7) + 5;
                });

                y += 20;
                doc.text(`Localidade, ${dataAtual}.`, 190, y, { align: 'right' });
                
                y += 40;
                doc.line(30, y, 90, y);
                doc.line(120, y, 180, y);
                doc.text("CONTRATANTE", 60, y + 5, { align: 'center' });
                doc.text("CONTRATADO", 150, y + 5, { align: 'center' });

                doc.save(`Contrato_${cli.nome}.pdf`);
            };
        }

        // --- MANUTENÇÃO DO CÓDIGO ANTERIOR (BLINDADO) ---
        function carregarClientes() {
            db.transaction("clientes").objectStore("clientes").getAll().onsuccess = (e) => {
                window.clientes = e.target.result;
                renderizarTabela();
            };
        }

        function renderizarTabela() {
            const b = document.getElementById('input-busca').value.toLowerCase();
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = window.clientes.filter(c => c.nome.toLowerCase().includes(b) || c.cnpj.includes(b)).map(c => `
                <tr class="hover:bg-white/5 cursor-pointer transition-all" onclick="abrirDetalhes(${c.id})">
                    <td class="px-6 py-4 text-sm font-semibold text-slate-200">${c.nome}</td>
                    <td class="px-6 py-4 text-xs font-mono text-indigo-400">${c.cnpj}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="event.stopPropagation(); editarCliente(${c.id})" class="text-slate-500 hover:text-white px-2"><i class="fas fa-edit text-sm"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        let clienteAtivo = null;
        function abrirDetalhes(id) {
            clienteAtivo = window.clientes.find(x => x.id === id);
            renderizarPainelInfo();
            carregarPastasGrid();
            router('detalhes');
        }

        function toggleSeguranca() { segurancaAtiva = !segurancaAtiva; renderizarPainelInfo(); }

        function renderizarPainelInfo() {
            const c = clienteAtivo;
            const eyeIcon = segurancaAtiva ? 'fa-eye-slash' : 'fa-eye';
            const passClass = segurancaAtiva ? 'password-hide' : '';
            document.getElementById('painel-info-cliente').innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-extrabold text-white mb-2">${c.nome}</h2>
                        <div class="flex flex-col gap-1">
                            <span class="text-xs bg-indigo-600/20 text-indigo-400 px-3 py-1 rounded font-mono border border-indigo-500/20 w-fit">${c.cnpj}</span>
                            <span class="text-[10px] text-slate-400 mt-2 uppercase tracking-wider">
                                <i class="fas fa-map-marker-alt mr-1 text-indigo-500"></i> ${c.rua || 'Endereço não informado'}, ${c.num || 'S/N'} — ${c.bairro_cid || ''}
                            </span>
                        </div>
                    </div>
                    <button onclick="toggleSeguranca()" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl border border-white/10 text-slate-400"><i class="fas ${eyeIcon}"></i></button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Prefeitura</p><p class="text-sm font-bold text-white ${passClass}">${c.s_pref || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Simples</p><p class="text-sm font-bold text-white ${passClass}">${c.s_simp || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Seguro</p><p class="text-sm font-bold text-white ${passClass}">${c.s_seg || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">A1</p><p class="text-xs font-bold text-white truncate ${passClass}">${c.a1 || '---'}</p></div>
                </div>`;
        }

        // Funções de CEP e Cadastro (Mantidas Intactas)
        async function buscarCEP(valor) {
            const cep = valor.replace(/\D/g, "");
            if (cep.length !== 8) return;
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('f-rua').value = data.logradouro;
                    document.getElementById('f-bairro-cid').value = `${data.bairro} - ${data.localidade}/${data.uf}`;
                    document.getElementById('f-num').focus();
                }
            } catch (error) { console.error(error); }
        }

        function mascaraCEP(i) { i.value = i.value.replace(/\D/g, "").replace(/^(\d{5})(\d)/, "$1-$2"); }
        function mascaraCNPJ(i) { i.value = i.value.replace(/\D/g, "").replace(/^(\d{2})(\d)/, "$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3").replace(/\.(\d{3})(\d)/, ".$1/$2").replace(/(\d{4})(\d)/, "$1-$2"); }
        
        // Outras funções auxiliares (Upload, Pastas, etc - Mantidas do código blindado)
        function carregarPastasGrid() {
            db.transaction("pastas").objectStore("pastas").getAll().onsuccess = (e) => {
                const pastas = e.target.result.filter(p => p.clienteId === clienteAtivo.id);
                document.getElementById('grid-pastas').innerHTML = pastas.map(p => `
                    <div class="card-premium p-6 rounded-xl flex flex-col items-center hover:border-indigo-500 cursor-pointer relative group">
                        <div onclick="abrirPasta(${p.id}, '${p.nome}')" class="flex flex-col items-center">
                            <i class="fas fa-folder text-indigo-500 text-3xl mb-3"></i>
                            <span class="font-bold text-white uppercase text-[9px] text-center">${p.nome}</span>
                        </div>
                    </div>`).join('');
            };
        }

        function abrirPasta(id, nome) { pastaAtivaId = id; document.getElementById('titulo-pasta-atual').innerText = nome; carregarArquivosGrid(); router('arquivos'); }

        function carregarArquivosGrid() {
            db.transaction("arquivos").objectStore("arquivos").getAll().onsuccess = (e) => {
                const arqs = e.target.result.filter(a => a.pastaId === pastaAtivaId);
                document.getElementById('grid-arquivos').innerHTML = arqs.map(a => `
                    <div class="card-premium p-4 rounded-xl flex flex-col items-center relative group">
                        <i class="fas fa-file-pdf text-red-500/80 text-2xl mb-2"></i>
                        <span class="text-[8px] font-bold text-slate-500 text-center truncate w-full mb-3 uppercase">${a.nome}</span>
                        <button onclick="abrirArquivo(${a.id})" class="w-full bg-indigo-600/10 text-indigo-400 py-2 rounded text-[9px] font-bold hover:bg-indigo-600 hover:text-white transition-all">ABRIR</button>
                    </div>`).join('');
            };
        }

        function abrirArquivo(id) { db.transaction("arquivos").objectStore("arquivos").get(id).onsuccess = (e) => { const a = e.target.result; window.open(URL.createObjectURL(new Blob([a.data], { type: a.tipo })), '_blank'); }; }
        function promptNovaPasta() { const n = prompt("Nome da Pasta:"); if(n) { db.transaction("pastas", "readwrite").objectStore("pastas").add({ clienteId: clienteAtivo.id, nome: n }); carregarPastasGrid(); } }
        function abrirModalCadastro() { document.getElementById('form-cliente').reset(); document.getElementById('field-id').value = ""; document.getElementById('btn-deletar-c').classList.add('hidden'); toggleModal('modal-cliente', true); }
        
        function editarCliente(id) { 
            const c = window.clientes.find(x => x.id === id); 
            document.getElementById('field-id').value = c.id; 
            document.getElementById('f-nome').value = c.nome; 
            document.getElementById('f-cnpj').value = c.cnpj; 
            document.getElementById('f-cep').value = c.cep || '';
            document.getElementById('f-rua').value = c.rua || '';
            document.getElementById('f-num').value = c.num || '';
            document.getElementById('f-bairro-cid').value = c.bairro_cid || '';
            document.getElementById('f-s-pref').value = c.s_pref || ''; 
            document.getElementById('f-s-simp').value = c.s_simp || ''; 
            document.getElementById('f-s-seg').value = c.s_seg || ''; 
            document.getElementById('f-a1').value = c.a1 || ''; 
            document.getElementById('btn-deletar-c').classList.remove('hidden'); 
            toggleModal('modal-cliente', true); 
        }

        document.getElementById('form-cliente').addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const id = document.getElementById('field-id').value;
            const c = { 
                nome: document.getElementById('f-nome').value, cnpj: document.getElementById('f-cnpj').value, 
                cep: document.getElementById('f-cep').value, rua: document.getElementById('f-rua').value,
                num: document.getElementById('f-num').value, bairro_cid: document.getElementById('f-bairro-cid').value,
                s_pref: document.getElementById('f-s-pref').value, s_simp: document.getElementById('f-s-simp').value, 
                s_seg: document.getElementById('f-s-seg').value, a1: document.getElementById('f-a1').value 
            }; 
            const tx = db.transaction("clientes", "readwrite"); 
            if(id) { c.id = Number(id); tx.objectStore("clientes").put(c); } 
            else tx.objectStore("clientes").add(c); 
            tx.oncomplete = () => { toggleModal('modal-cliente', false); carregarClientes(); }; 
        });

        function atualizarDash() { 
            db.transaction("clientes").objectStore("clientes").count().onsuccess = (e) => document.getElementById('dash-clientes').innerText = e.target.result; 
            db.transaction("arquivos").objectStore("arquivos").count().onsuccess = (e) => document.getElementById('dash-arquivos').innerText = e.target.result; 
        }

        function exportarBackup() {
            const backup = {};
            const stores = ["clientes", "pastas", "arquivos"];
            let count = 0;
            stores.forEach(s => {
                db.transaction(s).objectStore(s).getAll().onsuccess = (e) => {
                    backup[s] = e.target.result;
                    count++;
                    if(count === 3) {
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(new Blob([JSON.stringify(backup)], {type: "application/json"}));
                        a.download = `backup_vista.json`;
                        a.click();
                    }
                };
            });
        }
        
        async function consultarCNPJ() { 
            const cnpj = document.getElementById('f-cnpj').value.replace(/\D/g, ""); 
            if (cnpj.length !== 14) return; 
            const script = document.createElement('script'); 
            script.src = `https://receitaws.com.br/v1/cnpj/${cnpj}?callback=handleCNPJResponse`; 
            document.body.appendChild(script); 
        }
        window.handleCNPJResponse = function(d) { if (d.status === "OK") document.getElementById('f-nome').value = d.nome; };
    </script>
</body>
</html>
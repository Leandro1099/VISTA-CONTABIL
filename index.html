<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISTA CONTABIL | Enterprise Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --bg-deep: #0a0f1d; --bg-surface: #161e31; --accent: #6366f1; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-deep); color: #f1f5f9; overflow-x: hidden; }
        .card-premium { background: var(--bg-surface); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .sidebar-active { background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent); color: white !important; }
        .input-standard { background: rgba(10, 15, 29, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
        .input-standard:focus { border-color: var(--accent); outline: none; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .password-hide { font-family: 'text-security-disc'; -webkit-text-security: disc; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-[#070b14] border-r border-white/5 flex flex-col fixed h-full z-50">
        <div class="p-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-eye text-lg"></i></div>
                <h1 class="text-lg font-extrabold tracking-tighter text-white uppercase">Vista <span class="text-indigo-500 font-light">Contábil</span></h1>
            </div>
        </div>
        <nav class="flex-1 px-3 space-y-1 mt-4">
            <button onclick="router('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-chart-line w-5"></i> Dashboard</button>
            <button onclick="router('clientes')" id="nav-clientes" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-building w-5"></i> Clientes</button>
            <button onclick="router('busca')" id="nav-busca" class="w-full flex items-center gap-3 px-5 py-3 rounded-lg text-slate-400 font-medium hover:text-white transition-all text-sm"><i class="fas fa-search w-5"></i> Busca Global</button>
        </nav>
        <div class="p-4 border-t border-white/5">
            <button onclick="exportarBackup()" class="w-full text-[10px] text-slate-500 hover:text-white uppercase font-bold tracking-widest"><i class="fas fa-download mr-2"></i> Download Backup</button>
        </div>
    </aside>

    <main class="ml-64 flex-1 p-10 bg-[#0a0f1d]">
        <section id="view-dashboard" class="content-view">
            <h2 class="text-2xl font-bold text-white mb-8">Panorama Geral</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card-premium p-8 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total de Clientes</p>
                    <h3 id="dash-clientes" class="text-5xl font-extrabold text-white">0</h3>
                </div>
                <div class="card-premium p-8 rounded-2xl">
                    <p class="text-slate-400 text-xs font-bold uppercase mb-2">Arquivos Salvos</p>
                    <h3 id="dash-arquivos" class="text-5xl font-extrabold text-white">0</h3>
                </div>
            </div>
        </section>

        <section id="view-clientes" class="content-view hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white">Gestão de Clientes</h2>
                <div class="flex gap-2">
                    <button onclick="gerarRelatorioClientes()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition-all shadow-lg"><i class="fas fa-file-pdf mr-2"></i> Relatório</button>
                    <button onclick="abrirModalCadastro()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition-all shadow-lg">+ Novo Cliente</button>
                </div>
            </div>
            <div class="input-standard p-1 rounded-xl mb-6 flex items-center gap-3 px-4">
                <i class="fas fa-search text-slate-500 text-sm"></i>
                <input type="text" id="input-busca" onkeyup="renderizarTabela()" placeholder="Filtrar por nome ou CNPJ..." class="w-full py-2 bg-transparent outline-none text-sm">
            </div>
            <div class="card-premium rounded-xl overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white/5 border-b border-white/10">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Razão Social</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">CNPJ</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lista-clientes" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </section>

        <section id="view-busca" class="content-view hidden">
            <h2 class="text-2xl font-bold text-white mb-8">Busca Inteligente</h2>
            <div class="input-standard p-1 rounded-xl mb-8 flex items-center gap-3 px-4 border-2 border-indigo-500/20">
                <i class="fas fa-search text-indigo-500"></i>
                <input type="text" id="input-busca-global" onkeyup="executarBuscaGlobal()" placeholder="Digite o nome de um arquivo ou documento..." class="w-full py-3 bg-transparent outline-none text-sm">
            </div>
            <div id="resultados-busca" class="grid grid-cols-1 gap-4"></div>
        </section>

        <section id="view-detalhes" class="content-view hidden">
            <button onclick="router('clientes')" class="mb-6 text-sm text-indigo-400 hover:underline font-bold"><i class="fas fa-arrow-left mr-2"></i> Lista de Clientes</button>
            <div id="painel-info-cliente" class="card-premium rounded-2xl p-8 mb-8 relative"></div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Diretórios</h3>
                <button onclick="promptNovaPasta()" class="text-sm bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg border border-white/10 font-bold transition-all">Nova Pasta</button>
            </div>
            <div id="grid-pastas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>

        <section id="view-arquivos" class="content-view hidden">
            <button onclick="router('detalhes')" class="mb-6 text-sm text-indigo-400 hover:underline font-bold"><i class="fas fa-arrow-left mr-2"></i> Pastas</button>
            <div class="bg-indigo-600/20 border border-indigo-500/30 p-8 rounded-2xl flex justify-between items-center mb-4">
                <h3 id="titulo-pasta-atual" class="text-2xl font-bold text-white"></h3>
                <label class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold text-sm cursor-pointer hover:bg-indigo-500">Subir PDF<input type="file" class="hidden" onchange="fazerUpload(this)"></label>
            </div>
            
            <div id="container-progresso" class="hidden w-full bg-white/5 h-2 rounded-full mb-8 overflow-hidden">
                <div id="barra-progresso" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
            </div>

            <div id="grid-arquivos" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </section>
    </main>

    <div id="modal-cliente" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-[100] p-6">
        <div class="bg-[#161e31] rounded-2xl w-full max-w-xl border border-white/10 shadow-2xl flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white">Cadastro de Empresa</h3>
                <button onclick="toggleModal('modal-cliente', false)" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-cliente" class="p-8 space-y-4">
                <input type="hidden" id="field-id">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">CNPJ (Consulta Automática)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="f-cnpj" maxlength="18" oninput="mascaraCNPJ(this)" placeholder="00.000.000/0000-00" class="flex-1 input-standard rounded-lg px-4 py-2.5 text-sm" required>
                            <button type="button" onclick="consultarCNPJ()" id="btn-consulta" class="bg-slate-700 hover:bg-indigo-600 text-white px-4 rounded-lg transition-all"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Razão Social</label>
                        <input type="text" id="f-nome" class="w-full input-standard rounded-lg px-4 py-2.5 text-sm mt-1" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="f-ie" placeholder="Insc. Estadual" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-s-pref" placeholder="Senha Pref." class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-s-simp" placeholder="Senha Simples" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-s-seg" placeholder="Senha Seguro" class="input-standard rounded-lg px-4 py-2.5 text-sm">
                    <input type="text" id="f-a1" placeholder="Certificado A1" class="col-span-2 input-standard rounded-lg px-4 py-2.5 text-sm">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold text-sm">Salvar Registro</button>
                    <button type="button" id="btn-deletar-c" class="hidden px-5 bg-red-600/10 text-red-500 rounded-lg font-bold text-sm hover:bg-red-600 hover:text-white transition-all">Excluir</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let db;
        let segurancaAtiva = true;
        const req = indexedDB.open("VistaEnterpriseDB", 1);
        
        req.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("clientes", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("pastas", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("arquivos", { keyPath: "id", autoIncrement: true });
        };
        req.onsuccess = (e) => { db = e.target.result; router('dashboard'); };

        // --- NAVEGAÇÃO ---
        function router(view) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('sidebar-active'));
            document.getElementById('view-' + view).classList.remove('hidden');
            const btn = document.getElementById('nav-' + view);
            if(btn) btn.classList.add('sidebar-active');
            
            if(view === 'clientes') carregarClientes();
            if(view === 'dashboard') atualizarDash();
            if(view === 'busca') document.getElementById('input-busca-global').focus();
        }

        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

        // --- CLIENTES ---
        function carregarClientes() {
            db.transaction("clientes").objectStore("clientes").getAll().onsuccess = (e) => {
                window.clientes = e.target.result;
                renderizarTabela();
            };
        }

        function renderizarTabela() {
            const b = document.getElementById('input-busca').value.toLowerCase();
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = window.clientes.filter(c => c.nome.toLowerCase().includes(b) || c.cnpj.includes(b)).map(c => `
                <tr class="hover:bg-white/5 cursor-pointer transition-all" onclick="abrirDetalhes(${c.id})">
                    <td class="px-6 py-4 text-sm font-semibold text-slate-200">${c.nome}</td>
                    <td class="px-6 py-4 text-xs font-mono text-indigo-400">${c.cnpj}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="event.stopPropagation(); editarCliente(${c.id})" class="text-slate-500 hover:text-white px-2"><i class="fas fa-edit text-sm"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // --- CNPJ API ---
        async function consultarCNPJ() {
            const cnpj = document.getElementById('f-cnpj').value.replace(/\D/g, "");
            if (cnpj.length !== 14) return alert("Digite um CNPJ válido.");
            const btn = document.getElementById('btn-consulta');
            const icon = btn.querySelector('i');
            icon.className = "fas fa-spinner loading-spin";
            const script = document.createElement('script');
            script.src = `https://receitaws.com.br/v1/cnpj/${cnpj}?callback=handleCNPJResponse`;
            document.body.appendChild(script);
        }

        window.handleCNPJResponse = function(data) {
            document.getElementById('btn-consulta').querySelector('i').className = "fas fa-search";
            if (data.status === "OK") document.getElementById('f-nome').value = data.nome;
            else alert("Erro na consulta.");
        };

        // --- DETALHES E SEGURANÇA ---
        let clienteAtivo = null;
        function abrirDetalhes(id) {
            clienteAtivo = window.clientes.find(x => x.id === id);
            renderizarPainelInfo();
            carregarPastasGrid();
            router('detalhes');
        }

        function toggleSeguranca() {
            segurancaAtiva = !segurancaAtiva;
            renderizarPainelInfo();
        }

        function renderizarPainelInfo() {
            const c = clienteAtivo;
            const eyeIcon = segurancaAtiva ? 'fa-eye-slash' : 'fa-eye';
            const passClass = segurancaAtiva ? 'password-hide' : '';
            
            document.getElementById('painel-info-cliente').innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-extrabold text-white mb-2">${c.nome}</h2>
                        <span class="text-xs bg-indigo-600/20 text-indigo-400 px-3 py-1 rounded font-mono border border-indigo-500/20">${c.cnpj}</span>
                    </div>
                    <button onclick="toggleSeguranca()" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl border border-white/10 text-slate-400">
                        <i class="fas ${eyeIcon}"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Prefeitura</p><p class="text-sm font-bold text-white ${passClass}">${c.s_pref || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Simples</p><p class="text-sm font-bold text-white ${passClass}">${c.s_simp || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">Seguro</p><p class="text-sm font-bold text-white ${passClass}">${c.s_seg || '---'}</p></div>
                    <div class="p-4 bg-black/20 rounded-xl border border-white/5"><p class="text-[9px] font-bold text-slate-500 uppercase">A1</p><p class="text-xs font-bold text-white truncate ${passClass}">${c.a1 || '---'}</p></div>
                </div>
            `;
        }

        // --- PASTAS E ARQUIVOS ---
        let pastaAtivaId = null;

        function promptNovaPasta() {
            const n = prompt("Nome da Pasta:");
            if(n) { db.transaction("pastas", "readwrite").objectStore("pastas").add({ clienteId: clienteAtivo.id, nome: n }); carregarPastasGrid(); }
        }

        function carregarPastasGrid() {
            db.transaction("pastas").objectStore("pastas").getAll().onsuccess = (e) => {
                const pastas = e.target.result.filter(p => p.clienteId === clienteAtivo.id);
                document.getElementById('grid-pastas').innerHTML = pastas.map(p => `
                    <div class="card-premium p-6 rounded-xl flex flex-col items-center hover:border-indigo-500 cursor-pointer relative group">
                        <div onclick="abrirPasta(${p.id}, '${p.nome}')" class="flex flex-col items-center">
                            <i class="fas fa-folder text-indigo-500 text-3xl mb-3"></i>
                            <span class="font-bold text-white uppercase text-[9px] text-center">${p.nome}</span>
                        </div>
                        <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100">
                             <button onclick="renomearPasta(${p.id}, '${p.nome}')" class="text-slate-500 hover:text-white"><i class="fas fa-edit text-[10px]"></i></button>
                             <button onclick="if(confirm('Excluir pasta?')) { db.transaction('pastas','readwrite').objectStore('pastas').delete(${p.id}); carregarPastasGrid(); }" class="text-slate-500 hover:text-red-500"><i class="fas fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                `).join('');
            };
        }

        function abrirPasta(id, nome) {
            pastaAtivaId = id;
            document.getElementById('titulo-pasta-atual').innerText = nome;
            carregarArquivosGrid();
            router('arquivos');
        }

        function fazerUpload(input) {
            const f = input.files[0]; if(!f) return;
            const bar = document.getElementById('barra-progresso');
            const cont = document.getElementById('container-progresso');
            
            cont.classList.remove('hidden');
            bar.style.width = '0%';

            const r = new FileReader();
            r.onprogress = (e) => { if(e.lengthComputable) bar.style.width = (e.loaded/e.total)*100 + '%'; };
            r.onload = () => {
                db.transaction("arquivos", "readwrite").objectStore("arquivos").add({ pastaId: pastaAtivaId, nome: f.name, tipo: f.type, data: r.result });
                setTimeout(() => { cont.classList.add('hidden'); carregarArquivosGrid(); }, 500);
            };
            r.readAsArrayBuffer(f);
        }

        function carregarArquivosGrid() {
            db.transaction("arquivos").objectStore("arquivos").getAll().onsuccess = (e) => {
                const arqs = e.target.result.filter(a => a.pastaId === pastaAtivaId);
                document.getElementById('grid-arquivos').innerHTML = arqs.map(a => `
                    <div class="card-premium p-4 rounded-xl flex flex-col items-center relative group">
                        <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100">
                             <button onclick="renomearArquivo(${a.id}, '${a.nome}')" class="text-slate-500 hover:text-white"><i class="fas fa-pen text-[10px]"></i></button>
                             <button onclick="if(confirm('Excluir?')) { db.transaction('arquivos','readwrite').objectStore('arquivos').delete(${a.id}); carregarArquivosGrid(); }" class="text-slate-500 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>
                        <i class="fas fa-file-pdf text-red-500/80 text-2xl mb-2"></i>
                        <span class="text-[8px] font-bold text-slate-500 text-center truncate w-full mb-3 uppercase">${a.nome}</span>
                        <button onclick="abrirArquivo(${a.id})" class="w-full bg-indigo-600/10 text-indigo-400 py-2 rounded text-[9px] font-bold hover:bg-indigo-600 hover:text-white transition-all">ABRIR</button>
                    </div>
                `).join('');
            };
        }

        // --- BUSCA GLOBAL ---
        async function executarBuscaGlobal() {
            const t = document.getElementById('input-busca-global').value.toLowerCase();
            const cont = document.getElementById('resultados-busca');
            if(t.length < 2) return cont.innerHTML = "";

            const [arqs, psts, clis] = await Promise.all([
                promisifyRequest(db.transaction("arquivos").objectStore("arquivos").getAll()),
                promisifyRequest(db.transaction("pastas").objectStore("pastas").getAll()),
                promisifyRequest(db.transaction("clientes").objectStore("clientes").getAll())
            ]);

            const res = arqs.filter(a => a.nome.toLowerCase().includes(t));
            cont.innerHTML = res.map(a => {
                const p = psts.find(x => x.id === a.pastaId);
                const c = clis.find(x => x.id === (p ? p.clienteId : null));
                return `
                    <div class="card-premium p-4 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <div>
                                <h4 class="text-white font-bold text-sm">${a.nome}</h4>
                                <p class="text-[10px] text-slate-500 uppercase">${c ? c.nome : '?'} > ${p ? p.nome : '?'}</p>
                            </div>
                        </div>
                        <button onclick="abrirArquivo(${a.id})" class="bg-indigo-600 text-white px-4 py-1.5 rounded text-xs font-bold">VER</button>
                    </div>
                `;
            }).join('');
        }

        // --- RELATÓRIOS E BACKUP ---
        async function gerarRelatorioClientes() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const clis = await promisifyRequest(db.transaction("clientes").objectStore("clientes").getAll());
            
            doc.text("LISTA DE ACESSOS - VISTA CONTABIL", 14, 15);
            doc.autoTable({
                startY: 20,
                head: [['Empresa', 'CNPJ', 'Pref.', 'Simples', 'Seguro', 'A1']],
                body: clis.map(c => [c.nome, c.cnpj, c.s_pref, c.s_simp, c.s_seg, c.a1]),
                theme: 'grid',
                styles: { fontSize: 7 }
            });
            doc.save("relatorio_vista.pdf");
        }

        async function exportarBackup() {
            const backup = {};
            for (const s of ["clientes", "pastas", "arquivos"]) backup[s] = await promisifyRequest(db.transaction(s).objectStore(s).getAll());
            const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `backup_vista_${new Date().getTime()}.json`; a.click();
        }

        // --- HELPERS ---
        function promisifyRequest(r) { return new Promise((res, rej) => { r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }); }
        
        function mascaraCNPJ(i) {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/, "$1.$2");
            v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
            v = v.replace(/(\d{4})(\d)/, "$1-$2");
            i.value = v;
        }

        function abrirArquivo(id) {
            db.transaction("arquivos").objectStore("arquivos").get(id).onsuccess = (e) => {
                const a = e.target.result;
                const url = URL.createObjectURL(new Blob([a.data], { type: a.tipo }));
                window.open(url, '_blank');
            };
        }

        function renomearPasta(id, antigo) {
            const n = prompt("Novo nome:", antigo);
            if(n) { 
                const tx = db.transaction("pastas", "readwrite");
                const s = tx.objectStore("pastas");
                s.get(id).onsuccess = (e) => { const d = e.target.result; d.nome = n; s.put(d); carregarPastasGrid(); };
            }
        }

        function renomearArquivo(id, antigo) {
            const n = prompt("Novo nome:", antigo);
            if(n) { 
                const tx = db.transaction("arquivos", "readwrite");
                const s = tx.objectStore("arquivos");
                s.get(id).onsuccess = (e) => { const d = e.target.result; d.nome = n; s.put(d); carregarArquivosGrid(); };
            }
        }

        function abrirModalCadastro() {
            document.getElementById('form-cliente').reset();
            document.getElementById('field-id').value = "";
            document.getElementById('btn-deletar-c').classList.add('hidden');
            toggleModal('modal-cliente', true);
        }

        document.getElementById('form-cliente').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('field-id').value;
            const c = {
                nome: document.getElementById('f-nome').value,
                cnpj: document.getElementById('f-cnpj').value,
                ie: document.getElementById('f-ie').value,
                s_pref: document.getElementById('f-s-pref').value,
                s_simp: document.getElementById('f-s-simp').value,
                s_seg: document.getElementById('f-s-seg').value,
                a1: document.getElementById('f-a1').value
            };
            const tx = db.transaction("clientes", "readwrite");
            if(id) { c.id = Number(id); tx.objectStore("clientes").put(c); }
            else { tx.objectStore("clientes").add(c); }
            tx.oncomplete = () => { toggleModal('modal-cliente', false); carregarClientes(); };
        });

        function editarCliente(id) {
            const c = window.clientes.find(x => x.id === id);
            document.getElementById('field-id').value = c.id;
            document.getElementById('f-nome').value = c.nome;
            document.getElementById('f-cnpj').value = c.cnpj;
            document.getElementById('f-ie').value = c.ie || '';
            document.getElementById('f-s-pref').value = c.s_pref || '';
            document.getElementById('f-s-simp').value = c.s_simp || '';
            document.getElementById('f-s-seg').value = c.s_seg || '';
            document.getElementById('f-a1').value = c.a1 || '';
            document.getElementById('btn-deletar-c').classList.remove('hidden');
            document.getElementById('btn-deletar-c').onclick = () => {
                if(confirm("Excluir empresa?")) {
                    db.transaction("clientes", "readwrite").objectStore("clientes").delete(id);
                    toggleModal('modal-cliente', false); carregarClientes();
                }
            };
            toggleModal('modal-cliente', true);
        }

        function atualizarDash() {
            db.transaction("clientes").objectStore("clientes").count().onsuccess = (e) => document.getElementById('dash-clientes').innerText = e.target.result;
            db.transaction("arquivos").objectStore("arquivos").count().onsuccess = (e) => document.getElementById('dash-arquivos').innerText = e.target.result;
        }
    </script>
</body>
</html>